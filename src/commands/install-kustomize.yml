description: >
  Install kustomize for your job.

parameters:
  version:
    type: string
    description: "ex. v5.7.1"
    default: "latest"

steps:
  - run:
      name: install kustomize
      command: |
        if [ -f "/usr/local/bin/kustomize" ]; then
          echo "kustomize already installed"
          kustomize version
          exit 0
        elif [ << parameters.version >> = "latest" ]; then
          VERSION=$(curl -sI https://github.com/kubernetes-sigs/kustomize/releases/latest \
          | grep -i location: \
          | sed -E 's#.*/(v[0-9]+\.[0-9]+\.[0-9]+).*#\1#')
        else
          VERSION=<< parameters.version >>
        fi
        echo "install version: $VERSION"

        curl -L -o kustomize.tar.gz https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/${VERSION}/kustomize_${VERSION}_linux_amd64.tar.gz
        tar -zxvf kustomize.tar.gz
        sudo mv kustomize /usr/local/bin/
        kustomize version
